
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dice Roller with Tension Timers & Rulebook</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=League+Spartan:wght@400;500;600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* --- START OF APP STYLES --- */
        :root {
            --bg-primary: #f8fafc; /* Will be overridden by body's blue */
            --bg-secondary: #ffffff; /* White, for elements like left column, modals */
            --bg-tertiary: #e9eff3;
            --text-primary: #2c3e50; /* Original dark text */
            --text-secondary: #526c84; /* Original dark text */
            --border-color: #dce4ec;

            --countdown-block-normal-fill: #2980b9; /* This is a nice blue */
            --countdown-text-normal-color: var(--text-primary); /* Will need adjustment if on blue */

            /* ... other color variables ... */
            --timer-gradient-warning-start: #fdd835;
            --timer-gradient-warning-end: #f9a825;
            --countdown-block-warning-fill: var(--timer-gradient-warning-end);
            --timer-text-warning-color: white;
            --countdown-text-warning-color: var(--text-primary);

            --timer-gradient-danger-start: #ef5350;
            --timer-gradient-danger-end: #d32f2f;
            --countdown-block-danger-fill: var(--timer-gradient-danger-end);
            --timer-text-danger-color: white;
            --countdown-text-danger-color: var(--text-primary);

            --timer-gradient-normal-start: #6cb2e9;
            --timer-gradient-normal-end: #2991de;
            --timer-text-normal-color: white;

            --accent-secondary: #8e44ad;
            --success: #27ae60;
            --failure: #c0392b;
            --warning-button-bg: #f1c40f;
            --shadow-light: rgba(44, 62, 80, 0.08);
            --shadow-medium: rgba(44, 62, 80, 0.12);

            /* NEW variables for blue theme */
            --main-page-blue-bg: var(--countdown-block-normal-fill); /* #2980b9 */
            --text-on-main-blue: #ffffff;
            --text-on-main-blue-secondary: #ecf0f1; /* Lighter gray for secondary text on blue */
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        html {
            width: 100%;
            margin: 0;
            padding: 0;
            overflow-x: hidden; /* Prevent horizontal scrollbars */
        }

        body {
            font-family: 'League Spartan', 'Inter', system-ui, sans-serif;
            font-weight: 400;
            line-height: 1.6;
            color: var(--text-on-main-blue) !important; /* Default text white, important to override rulebook body */
            min-height: 100vh;
            width: 100%; /* Ensured by html and * reset */
        }

        .app-title-header { text-align: center; padding: 20px 0; margin-bottom: 20px; }
        .app-title-header h1 {
            font-size: 2.8rem;
            font-weight: 800;
            color: var(--text-on-main-blue); /* Changed from blue to white */
            letter-spacing: 1px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5); /* Adjusted shadow for dark BG */
        }

        .main-layout-container {
            display: grid;
            grid-template-columns: 280px 1fr; /* Kept original layout, review for smaller screens if needed */
            gap: 30px;
            /* max-width: 900px; REMOVED */
            width: 100%; /* CHANGED for full width */
            max-width: none; /* Ensure no max-width */
            /* margin: 0 auto; REMOVED */
            margin: 0; /* Ensure no auto margin */
            padding: 0 20px 30px 20px; /* Keep side padding */
        }

        /* .left-column and other elements with var(--bg-secondary) will remain white, contrasting the blue page */
        .left-column {
            padding: 20px;
            background-color: var(--bg-secondary); /* Stays white */
            border-radius: 12px;
            box-shadow: 0 4px 12px var(--shadow-light);
            align-self: start;
        }
        .right-column {
            /* No background defined, so it will show the body's blue background */
        }

        header.controls-header {
            /* border-bottom color is blue, might blend. Consider a lighter border */
            border-bottom: 2px solid var(--text-on-main-blue-secondary); /* Lighter border */
        }

        .difficulty-control .difficulty-label {
            color: var(--text-on-main-blue-secondary); /* Light text */
        }
        #difficultyDisplay {
            color: var(--text-on-main-blue); /* Light text */
            /* Was: var(--countdown-block-normal-fill); */
        }
        /* Buttons with light background (var(--bg-tertiary)) should keep dark text */
        .difficulty-buttons-group button {
            background-color: var(--bg-tertiary);
            color: var(--text-primary); /* Keep dark text on light button BG */
        }
        .difficulty-buttons-group button:hover {
            background-color: var(--countdown-block-normal-fill);
            color: white;
        }

        .timer-label {
            color: var(--text-on-main-blue-secondary); /* Light text */
        }
        /* Timers visual containers */
        .visual-timer-container {
            background-color: var(--bg-tertiary); /* Keeps light background */
        }
        /* Timer text should be dark on light visual timer background */
        #tensionTimerVisualContainer .timer-text-content {
            /* color: transparent; Uses gradient fill, which should be fine */
        }
        #countdownVisualContainer .countdown-text-content {
            color: var(--text-primary); /* Keep dark on light visual timer background */
        }
        /* Timer buttons (duration, inc/dec) */
        .timer-btn, .duration-btn, .countdown-numerator-buttons button {
            background-color: var(--bg-tertiary);
            color: var(--text-primary); /* Keep dark text on light button BG */
        }
        .timer-btn:hover, .duration-btn:hover, .countdown-numerator-buttons button:hover {
            background-color: var(--countdown-block-normal-fill);
            color: white;
        }
        .duration-btn.active {
            background-color: var(--countdown-block-normal-fill);
            color: white;
        }
        #countdownDenominatorInput {
            background-color: var(--bg-primary); /* Light BG */
            color: var(--text-primary); /* Dark text */
        }


        .status {
            padding: 14px 18px;
            background-color: var(--bg-secondary); /* Stays white */
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            color: var(--text-primary); /* Dark text on white status bg */
            font-weight: 500;
            font-size: 1.05rem;
            box-shadow: 0 2px 8px var(--shadow-light);
            border-left: 4px solid var(--countdown-block-normal-fill); /* Blue accent border */
        }

        /* Roll/Reset buttons - already have good contrast */

        /* Special action buttons - warning (yellow) bg, dark text */
        .special-action-buttons-container button {
            background-color: var(--warning-button-bg);
            color: var(--text-primary); /* Dark text on yellow */
        }

        .players-section h2 {
            font-size: 1.5rem;
            color: var(--text-on-main-blue); /* Light text */
            margin-bottom: 18px;
            padding-bottom: 10px;
            font-weight: 600;
            border-bottom: 1px solid var(--text-on-main-blue-secondary); /* Lighter border */
            text-align: center;
        }
        .player-item {
            background-color: var(--bg-primary); /* Light background for player items for contrast */
        }
        .player-name-label {
            color: var(--text-primary); /* Dark text on light player item */
        }
        /* Player action buttons (dice, star icons) */
        .player-action-btn {
            background: var(--bg-secondary); /* White */
            color: var(--text-secondary); /* Dark icon */
        }
        .add-player-button {
            border: 2.5px dashed var(--text-on-main-blue-secondary); /* Lighter border */
            color: var(--text-on-main-blue-secondary); /* Light text for button on blue bg */
        }
        .add-player-button:hover {
            color: var(--text-on-main-blue);
            border-color: var(--text-on-main-blue);
            background-color: rgba(255,255,255,0.1); /* Slight highlight on blue */
        }
        .no-players-text {
            font-size: 0.95rem;
            color: var(--text-on-main-blue-secondary); /* Light text */
            margin-top: 15px;
            text-align: center;
        }

        /* Dice Pool */
        .dice-pool-display {
            background-color: var(--bg-secondary); /* Stays white */
        }
        /* Dice slots */
        .dice-slot {
            background-color: var(--bg-tertiary); /* Light BG for dice slots */
        }
        /* Die face text is already white, which is good for colored dice */

        /* Modal */
        .modal-content {
            background-color:var(--bg-secondary); /* Modal content white */
        }
        .modal-content h2 {
            color: var(--countdown-block-normal-fill); /* Blue heading on white modal */
        }
        .form-group label {
            color:var(--text-secondary); /* Dark label on white modal */
        }
        .form-group input[type="text"], .form-group input[type="file"] {
            background-color:var(--bg-primary); /* Light input BG */
            color:var(--text-primary); /* Dark input text */
        }
        .modal-actions button:first-child { /* Cancel button */
            background-color:transparent;
            color:var(--text-secondary); /* Dark text */
            border:1px solid var(--border-color);
        }
        .modal-actions button:first-child:hover {
            background-color:var(--bg-tertiary);
        }
        /* Add player button (confirm) in modal is blue with white text, which is fine */


        /* --- END OF APP STYLES --- */
    </style>
    <!-- START OF RULEBOOK STYLES (copied from rulebook.html's head) -->
    <style>
        /* Universal CSS Reset already handled by app styles */

        /* Global Styles for Rulebook - Body styles from here are overridden by app's body styles */
        /* body { ... } */

        /* Rulebook main content area */
        #rulebookDisplaySection .container {
          /* width: 90% !important; REMOVED */
          /* max-width: 1200px !important; REMOVED */
          width: 100% !important; /* CHANGED for full width */
          max-width: none !important; /* Ensure no max-width */
          /* margin: 50px auto !important; REMOVED */
          margin: 0 !important; /* Reset margin */
          background-color: #fff !important; /* Keep rulebook content background white for readability */
          padding: 65px 20px !important; /* Keep padding, adjust as needed */
          /* box-shadow: 0 0 10px rgba(0,0,0,0.1) !important; Keep shadow */
          border-left: 5px solid #2991de !important; /* Keep borders */
          border-right: 5px solid #2991de !important;
          color: #333 !important; /* Ensure text inside rulebook is dark on its white BG */
        }

        /* Headings inside rulebook should retain their blue color on white BG */
        #rulebookDisplaySection .container h1,
        #rulebookDisplaySection .container h2,
        #rulebookDisplaySection .container h3,
        #rulebookDisplaySection .container h4,
        #rulebookDisplaySection .container h5 {
          color: #2991de !important; /* Original blue headings */
        }
        #rulebookDisplaySection .container .subtitle {
          color: #555 !important; /* Original dark subtitle */
        }
        /* Paragraphs and list items will inherit dark color from .container */
        #rulebookDisplaySection .container p {
          /* ... */
        }
        #rulebookDisplaySection .container ul {
          /* ... */
        }
        #rulebookDisplaySection .container li {
          /* ... */
        }
        #rulebookDisplaySection .container .accent {
          color: #2991de !important; /* Original blue accent */
        }
        /* Notes and other special blocks - ensure their text is dark if their BG is light */
        #rulebookDisplaySection .container .note {
          background-color: #e0f0ff !important; /* Original light blue */
          border-left: 4px solid #2991de !important;
          padding: 10px 15px !important;
          margin: 20px 0 !important;
          font-size: 20px !important;
          color: #333 !important; /* Ensure dark text */
        }
        /* ... (check other specific text colorations if any look off) ... */


        /* Responsive for rulebook content */
        @media (max-width: 600px) {
          #rulebookDisplaySection .container {
            padding: 20px 10px !important; /* Adjusted padding */
            /* margin: 20px auto !important; REMOVED */
            margin: 0 !important; /* Ensure no auto margin */
            border-left-width: 2px !important; /* Thinner border on mobile */
            border-right-width: 2px !important;
          }
          /* ... other responsive rulebook styles ... */
        }
    </style>
    <!-- END OF RULEBOOK STYLES -->
</head>
<body>
  <!-- YOUR HTML CONTENT REMAINS THE SAME -->
  <div class="dice-roller-app">
    <div class="app-title-header">
      <h1>DICE ROLLER</h1>
    </div>

    <div class="main-layout-container">
      <div class="left-column players-section">
        <h2>Players</h2>
        <div id="playerList" class="player-list">
          <!-- Player items will be rendered here by JS -->
        </div>
        <button id="openAddPlayerModalBtn" class="add-player-button" title="Add New Player">
          + Add Player
        </button>
        <p id="noPlayersText" class="no-players-text" style="display: none;">No players yet. Click '+' to add.</p>
      </div>

      <div class="right-column">
        <header class="controls-header">
          <div class="difficulty-control">
            <span class="difficulty-label">DIFFICULTY:</span>
            <div class="difficulty-buttons-group">
              <button id="decreaseDifficultyBtn">-</button>
              <span id="difficultyDisplay">2</span>
              <button id="increaseDifficultyBtn">+</button>
            </div>
          </div>
        </header>

        <div id="dicePoolDisplay" class="dice-pool-display">
          <!-- Dice slots will be rendered here by JS -->
        </div>

        <div class="tension-timers-section">
          <div class="timer-controls-row">
            <div class="timer-control-group">
              <div class="timer-label">Tension Timer</div>
              <div class="visual-timer-container" id="tensionTimerVisualContainer">
                  <svg class="timer-svg-border" width="100%" height="100%">
                      <defs>
                          <linearGradient id="tensionGradientNormalDef" x1="0%" y1="0%" x2="100%" y2="0%">
                              <stop offset="0%" stop-color="var(--timer-gradient-normal-start)" />
                              <stop offset="100%" stop-color="var(--timer-gradient-normal-end)" />
                          </linearGradient>
                          <linearGradient id="tensionGradientWarningDef" x1="0%" y1="0%" x2="100%" y2="0%">
                              <stop offset="0%" stop-color="var(--timer-gradient-warning-start)" />
                              <stop offset="100%" stop-color="var(--timer-gradient-warning-end)" />
                          </linearGradient>
                          <linearGradient id="tensionGradientDangerDef" x1="0%" y1="0%" x2="100%" y2="0%">
                              <stop offset="0%" stop-color="var(--timer-gradient-danger-start)" />
                              <stop offset="100%" stop-color="var(--timer-gradient-danger-end)" />
                          </linearGradient>
                      </defs>
                      <rect id="tensionTimerSvgBorderRect" />
                  </svg>
                  <span id="tensionTimerText" class="timer-text-content">0s</span>
              </div>
                <div class="timer-buttons">
                <button class="duration-btn" data-duration="45">React</button>
                <button class="duration-btn" data-duration="90">Sync</button>
                <button class="duration-btn" data-duration="150">Plan</button>
              </div>
            </div>

            <div class="timer-control-group">
              <div class="timer-label">Turns Left</div>
                <div class="visual-timer-container" id="countdownVisualContainer">
                    <div id="countdownBlockContainer" class="countdown-block-container">
                        <!-- Blocks will be generated by JS -->
                    </div>
                    <span id="countdownText" class="countdown-text-content">6 / 6</span>
                </div>
                <div class="countdown-controls-underneath">
                    <div class="countdown-numerator-controls">
                        <div class="countdown-numerator-buttons">
                            <button id="increaseCountdownBtn" title="Increase current count">+</button>
                            <button id="decreaseCountdownBtn" title="Decrease current count">-</button>
                        </div>
                        <label for="countdownDenominatorInput" class="visually-hidden">Max Countdown:</label>
                        <input type="number" id="countdownDenominatorInput" value="6" min="1" max="20" title="Set max count (denominator)">
                    </div>
                </div>
            </div>
          </div>
        </div>

        <div id="statusMessage" class="status">Ready to roll!</div>

        <div class="actions-group">
            <button id="rollDiceBtn" class="btn-roll roll-mode">Roll Dice</button>
        </div>
        <div id="specialActionButtonsContainer" class="special-action-buttons-container">
            <button id="pushLuckBtn" style="display:none;">Push Your Luck</button>
            <button id="payPriceBtn" style="display:none;">Pay Price & Redo Roll</button>
        </div>

      </div>
    </div>

    <div id="addPlayerModal" class="modal" style="display: none;">
      <div class="modal-content">
        <h2>Add New Player</h2>
        <div class="form-group">
          <label for="playerNameInput">Player Name</label>
          <input id="playerNameInput" type="text" />
        </div>
        <div class="form-group">
          <label for="playerImageInput">Profile Image (Optional)</label>
          <input id="playerImageInput" type="file" accept="image/*" />
          <div id="imagePreviewContainer" class="image-preview" style="display:none;">
            <img id="imagePreview" src="#" alt="Preview" />
          </div>
        </div>
        <div class="modal-actions">
          <button id="cancelAddPlayerBtn">Cancel</button>
          <button id="confirmAddPlayerBtn">Add Player</button>
        </div>
      </div>
    </div>
  </div>
  <script>
    // YOUR JAVASCRIPT REMAINS THE SAME
    // --- GLOBAL STATE & CONFIG ---
    let difficulty = 2;
    let expertise = 0;
    let specialMoves = 0;
    let rolls = [];
    let outcomeText = "";
    let isRolling = false;
    let hasRolledThisTurn = false;
    let canPushLuck = false;
    let canPayPrice = false;
    let pushedLuckDieRoll = null;
    let isRedoingRollAfterPrice = false;
    let indexOfRollToRedo = -1;

    let players = [];
    let diceContributions = [];
    let specialMoveContributions = [];

    let uploadedImage = null;

    let currentRollIndex = null;
    let currentAnimatedValue = null;
    let sequenceChainTimeoutId = null;
    let currentSequenceTotalDice = 0;

    let nextPlayerHue = 0;
    const HUE_INCREMENT = 37;
    const SATURATION = 70;
    const LIGHTNESS = 55;

    let tensionTimerInterval = null;
    let isTensionTimerRunning = false;
    let tensionTimerStartTime = 0;
    let tensionTimerPausedTime = 0;
    let tensionTimerSeconds = 0;
    let tensionTimerTotalDurationSet = 0;
    let tensionTimerBorderPerimeter = 300;

    let countdownClock = 3;
    let countdownClockDenominator = 6;

    const SINGLE_DIE_ANIMATION_FRAMES = 12;
    const SINGLE_DIE_ANIMATION_INTERVAL = 60;
    const SINGLE_DIE_POST_ANIMATION_PAUSE = 350;
    const BASE_DELAY_AFTER_DIE_FINISHES = 150;
    const DELAY_INCREMENT_PER_DIE = 75;

    document.addEventListener('DOMContentLoaded', () => {
        const dicePoolDisplayEl = document.getElementById('dicePoolDisplay');
        const playerListEl = document.getElementById('playerList');
        const noPlayersTextEl = document.getElementById('noPlayersText');
        const statusMessageEl = document.getElementById('statusMessage');
        const rollDiceBtn = document.getElementById('rollDiceBtn');
        const pushLuckBtn = document.getElementById('pushLuckBtn');
        const payPriceBtn = document.getElementById('payPriceBtn');
        const openAddPlayerModalBtn = document.getElementById('openAddPlayerModalBtn');

        const difficultyDisplay = document.getElementById('difficultyDisplay');
        const decreaseDifficultyBtn = document.getElementById('decreaseDifficultyBtn');
        const increaseDifficultyBtn = document.getElementById('increaseDifficultyBtn');

        const tensionTimerVisualContainer = document.getElementById('tensionTimerVisualContainer');
        const tensionTimerTextEl = document.getElementById('tensionTimerText');
        const tensionTimerSvgBorderRectEl = document.getElementById('tensionTimerSvgBorderRect');
        const durationButtons = document.querySelectorAll('.duration-btn');

        const countdownVisualContainer = document.getElementById('countdownVisualContainer');
        const countdownTextEl = document.getElementById('countdownText');
        const countdownBlockContainerEl = document.getElementById('countdownBlockContainer');
        const decreaseCountdownBtn = document.getElementById('decreaseCountdownBtn');
        const increaseCountdownBtn = document.getElementById('increaseCountdownBtn');
        const countdownDenominatorInputEl = document.getElementById('countdownDenominatorInput');


        const addPlayerModalEl = document.getElementById('addPlayerModal');
        const playerNameInput = document.getElementById('playerNameInput');
        const playerImageInput = document.getElementById('playerImageInput');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');
        const imagePreviewEl = document.getElementById('imagePreview');
        const cancelAddPlayerBtn = document.getElementById('cancelAddPlayerBtn');
        const confirmAddPlayerBtn = document.getElementById('confirmAddPlayerBtn');

        const DICE_ICON = '🎲';
        const STAR_ICON = '✨';
        const USER_ICON = '👤';

        function calculateTensionTimerSvgBorderPerimeter() {
            const svgRect = tensionTimerSvgBorderRectEl;
            if (svgRect) {
                const containerWidth = tensionTimerVisualContainer.offsetWidth;
                const containerHeight = tensionTimerVisualContainer.offsetHeight;
                const strokeWidthStyle = getComputedStyle(svgRect).strokeWidth;
                const strokeWidth = parseFloat(strokeWidthStyle) || 6;

                if (containerWidth > strokeWidth && containerHeight > strokeWidth) {
                    const rectEffectiveWidth = containerWidth - strokeWidth;
                    const rectEffectiveHeight = containerHeight - strokeWidth;
                    tensionTimerBorderPerimeter = 2 * (rectEffectiveWidth + rectEffectiveHeight);
                    if (isFinite(tensionTimerBorderPerimeter) && tensionTimerBorderPerimeter > 0) {
                         svgRect.style.strokeDasharray = tensionTimerBorderPerimeter;
                    } else {
                        tensionTimerBorderPerimeter = 300;
                        svgRect.style.strokeDasharray = tensionTimerBorderPerimeter;
                    }
                } else {
                    tensionTimerBorderPerimeter = 300;
                    svgRect.style.strokeDasharray = tensionTimerBorderPerimeter;
                }
            }
        }
        setTimeout(calculateTensionTimerSvgBorderPerimeter, 150);


        function generatePlayerColor() {
            const hue = nextPlayerHue;
            nextPlayerHue = (nextPlayerHue + HUE_INCREMENT) % 360;
            return `hsl(${hue}, ${SATURATION}%, ${LIGHTNESS}%)`;
        }

        function updateTensionTimerDisplay() {
            const totalSecondsForDisplay = tensionTimerTotalDurationSet > 0 ? tensionTimerTotalDurationSet : 1;

            const minutes = Math.floor(tensionTimerSeconds / 60);
            const seconds = tensionTimerSeconds % 60;

            let displayText;
            if (minutes > 0) {
                displayText = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            } else {
                displayText = `${seconds}s`;
            }
            tensionTimerTextEl.textContent = displayText;

            let fillPercentage = 0;
            if (tensionTimerTotalDurationSet > 0) {
                fillPercentage = Math.max(0, (tensionTimerSeconds / tensionTimerTotalDurationSet));
            }

            const borderOffset = tensionTimerBorderPerimeter * (1 - fillPercentage);
            tensionTimerSvgBorderRectEl.style.strokeDashoffset = borderOffset;

            let currentGradientUrl = 'url(#tensionGradientNormalDef)';
            let currentGradientCss = `linear-gradient(90deg, var(--timer-gradient-normal-start), var(--timer-gradient-normal-end))`;

            if (tensionTimerTotalDurationSet > 0) {
                const percentRemaining = tensionTimerSeconds / tensionTimerTotalDurationSet;
                if (tensionTimerSeconds <= 0 || percentRemaining <= 0.25) {
                    currentGradientUrl = 'url(#tensionGradientDangerDef)';
                    currentGradientCss = `linear-gradient(90deg, var(--timer-gradient-danger-start), var(--timer-gradient-danger-end))`;
                } else if (percentRemaining <= 0.5) {
                    currentGradientUrl = 'url(#tensionGradientWarningDef)';
                    currentGradientCss = `linear-gradient(90deg, var(--timer-gradient-warning-start), var(--timer-gradient-warning-end))`;
                }
            } else {
                 tensionTimerSvgBorderRectEl.style.strokeDashoffset = tensionTimerBorderPerimeter;
                 tensionTimerTextEl.textContent = "0s";
            }
            tensionTimerSvgBorderRectEl.style.stroke = currentGradientUrl;
            tensionTimerTextEl.style.backgroundImage = currentGradientCss;
        }

        function startTensionTimerInternalLogic(duration) {
            if (tensionTimerInterval) clearInterval(tensionTimerInterval);

            tensionTimerTotalDurationSet = duration;
            tensionTimerSeconds = duration;
            isTensionTimerRunning = true;
            tensionTimerStartTime = Date.now();
            tensionTimerPausedTime = 0;

            updateTensionTimerDisplay();

            tensionTimerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - tensionTimerStartTime) / 1000);
                tensionTimerSeconds = Math.max(0, tensionTimerTotalDurationSet - elapsed);

                updateTensionTimerDisplay();

                if (tensionTimerSeconds <= 0) {
                    if (tensionTimerInterval) clearInterval(tensionTimerInterval);
                    tensionTimerInterval = null;
                    isTensionTimerRunning = false;
                    console.log("Tension Timer Expired!");
                }
            }, 100);
        }

        function haltTensionTimer() {
            if (tensionTimerInterval) {
                clearInterval(tensionTimerInterval);
                tensionTimerInterval = null;
            }
            isTensionTimerRunning = false;
        }

        function stopAndClearTensionTimer() {
            if (tensionTimerInterval) {
                clearInterval(tensionTimerInterval);
                tensionTimerInterval = null;
            }
            isTensionTimerRunning = false;
            tensionTimerSeconds = 0;
            tensionTimerTotalDurationSet = 0;
            tensionTimerPausedTime = 0;
            updateTensionTimerDisplay();
        }


        function updateCountdownDisplay() {
            countdownDenominatorInputEl.value = countdownClockDenominator;
            countdownTextEl.textContent = `${countdownClock} / ${countdownClockDenominator}`;
            countdownBlockContainerEl.innerHTML = '';

            const currentDenominator = countdownClockDenominator > 0 ? countdownClockDenominator : 1;
            const percentageValue = countdownClock / currentDenominator;
            let blockStateClass = 'normal';
            // Text color for countdownTextEl is now handled by CSS, based on its parent .visual-timer-container
            // let blockTextColor = 'var(--countdown-text-normal-color)';

            if (countdownClock === 0 && currentDenominator > 0) {
                 // blockTextColor = 'var(--text-secondary)';
            } else if (percentageValue <= 0.25 && countdownClock > 0) {
                blockStateClass = 'danger';
                // blockTextColor = 'var(--countdown-text-danger-color)';
            } else if (percentageValue <= 0.5 && countdownClock > 0) {
                blockStateClass = 'warning';
                // blockTextColor = 'var(--countdown-text-warning-color)';
            }
            // countdownTextEl.style.color = blockTextColor; // CSS handles this now

            for (let i = 0; i < currentDenominator; i++) {
                const block = document.createElement('div');
                block.classList.add('countdown-block');
                if (i < countdownClock) {
                    block.classList.add('active', blockStateClass);
                }
                countdownBlockContainerEl.appendChild(block);
            }
        }

        function handleDenominatorChange() {
            if (isRolling || hasRolledThisTurn) {
                countdownDenominatorInputEl.value = countdownClockDenominator;
                return;
            }
            let newDenominator = parseInt(countdownDenominatorInputEl.value, 10);
            if (isNaN(newDenominator) || newDenominator < 1) {
                newDenominator = 1;
            }
            newDenominator = Math.min(newDenominator, 20);
            countdownClockDenominator = newDenominator;
            countdownClock = Math.min(countdownClock, countdownClockDenominator);
            updateCountdownDisplay();
        }


        function adjustCountdownClock(amount) {
            if (isRolling || hasRolledThisTurn) return;
            countdownClock = Math.max(0, countdownClock + amount);
            countdownClock = Math.min(countdownClock, countdownClockDenominator);
            updateCountdownDisplay();
        }

        function resetCountdownClockValues() {
            countdownClockDenominator = 6;
            countdownClock = 3;
            countdownDenominatorInputEl.value = countdownClockDenominator;
            updateCountdownDisplay();
        }

        const getNumSpecialMovesVisuallyCoveringSlots = () => Math.min(specialMoves, Math.max(0, difficulty));
        const getNumPrimarySlotsForExpertiseOrEmpty = () => {
            const coveredBySM = getNumSpecialMovesVisuallyCoveringSlots();
            return Math.max(0, difficulty - coveredBySM);
        };
        const getDicePool = () => expertise;

        function renderDicePool() {
            dicePoolDisplayEl.innerHTML = '';
            let expertiseDieRenderedCount = 0;
            const numSMCovers = getNumSpecialMovesVisuallyCoveringSlots();

            for (let i = 0; i < Math.max(0, difficulty); i++) {
                const slotDiv = document.createElement('div');
                slotDiv.classList.add('dice-slot');
                const isCoveredBySpecialMove = i >= Math.max(0, difficulty) - numSMCovers;

                if (isCoveredBySpecialMove) {
                    slotDiv.classList.add('special-move-covered');
                    const smContributionIndex = (numSMCovers - 1) - (i - (Math.max(0, difficulty) - numSMCovers));
                    const playerId = specialMoveContributions[smContributionIndex];
                    const player = playerId ? players.find(p => p.id === playerId) : null;

                    if (player && player.image) {
                        const img = document.createElement('img');
                        img.classList.add('player-cover-image');
                        img.src = player.image;
                        img.alt = `${player.name} covers this`;
                        img.title = `${player.name} covers this difficulty`;
                        slotDiv.appendChild(img);
                    } else if (player) {
                         const initialDiv = document.createElement('div');
                         initialDiv.classList.add('player-initial-avatar');
                         initialDiv.style.width = '100%';
                         initialDiv.style.height = '100%';
                         initialDiv.style.borderRadius = '8px';
                         initialDiv.textContent = player.name.charAt(0).toUpperCase();
                         initialDiv.title = `${player.name} covers this difficulty (Initial)`;
                         initialDiv.style.backgroundColor = player.color;
                         slotDiv.appendChild(initialDiv);
                    } else {
                        const genericCoverDiv = document.createElement('div');
                        genericCoverDiv.classList.add('player-cover-image', 'generic-cover');
                        genericCoverDiv.innerHTML = STAR_ICON;
                        genericCoverDiv.title = "Special Move covers this";
                        slotDiv.appendChild(genericCoverDiv);
                    }
                } else {
                    if (expertiseDieRenderedCount < expertise) {
                        slotDiv.classList.add('filled');
                        const currentExpertiseDieOriginalIndex = expertiseDieRenderedCount;
                        const playerIdForExpertise = diceContributions[currentExpertiseDieOriginalIndex];
                        const playerForExpertise = playerIdForExpertise ? players.find(p => p.id === playerIdForExpertise) : null;

                        const dieFaceDiv = document.createElement('div');
                        dieFaceDiv.classList.add('die-face');
                        let content = DICE_ICON;
                        dieFaceDiv.classList.add('placeholder');

                        if ((isRolling || isRedoingRollAfterPrice) && currentExpertiseDieOriginalIndex === currentRollIndex && currentAnimatedValue !== null) {
                            content = currentAnimatedValue;
                            dieFaceDiv.classList.remove('placeholder', 'waiting', 'filled-placeholder');
                            if (currentAnimatedValue === 6) dieFaceDiv.classList.add('success', 'animating');
                            else if (currentAnimatedValue === 1) dieFaceDiv.classList.add('failure', 'animating');
                            else if (currentAnimatedValue >= 4) dieFaceDiv.classList.add('partial-success', 'animating');
                            else dieFaceDiv.classList.add('partial-failure', 'animating');
                        } else if (rolls[currentExpertiseDieOriginalIndex] !== undefined) {
                            content = rolls[currentExpertiseDieOriginalIndex];
                            dieFaceDiv.classList.remove('placeholder', 'waiting', 'filled-placeholder');
                            if (rolls[currentExpertiseDieOriginalIndex] === 6) dieFaceDiv.classList.add('success');
                            else if (rolls[currentExpertiseDieOriginalIndex] === 1) dieFaceDiv.classList.add('failure');
                            else if (rolls[currentExpertiseDieOriginalIndex] >= 4) dieFaceDiv.classList.add('partial-success');
                            else dieFaceDiv.classList.add('partial-failure');
                        } else if (isRolling || isRedoingRollAfterPrice) {
                            dieFaceDiv.classList.add("waiting");
                        } else {
                            dieFaceDiv.classList.add("filled-placeholder");
                        }
                        dieFaceDiv.innerHTML = content;
                        slotDiv.appendChild(dieFaceDiv);

                        if (playerForExpertise) {
                            const indicator = document.createElement('div');
                            indicator.classList.add('player-indicator');
                            indicator.title = `Expertise from ${playerForExpertise.name}`;
                            if (playerForExpertise.image) {
                                const imgPlayerIndicator = document.createElement('img');
                                imgPlayerIndicator.src = playerForExpertise.image;
                                imgPlayerIndicator.alt = playerForExpertise.name;
                                indicator.appendChild(imgPlayerIndicator);
                            } else {
                                indicator.classList.add('generic');
                                indicator.textContent = playerForExpertise.name.charAt(0).toUpperCase();
                                indicator.style.backgroundColor = playerForExpertise.color;
                            }
                            slotDiv.appendChild(indicator);
                        }
                        expertiseDieRenderedCount++;
                    } else {
                        slotDiv.classList.add('empty');
                    }
                }
                dicePoolDisplayEl.appendChild(slotDiv);
            }

            for (let k = expertiseDieRenderedCount; k < expertise; k++) {
                const slotDiv = document.createElement('div');
                slotDiv.classList.add('dice-slot', 'extra');
                const currentExpertiseDieOriginalIndex = k;
                const playerIdForExpertise = diceContributions[currentExpertiseDieOriginalIndex];
                const playerForExpertise = playerIdForExpertise ? players.find(p => p.id === playerIdForExpertise) : null;

                const dieFaceDiv = document.createElement('div');
                dieFaceDiv.classList.add('die-face');
                let content = DICE_ICON;
                dieFaceDiv.classList.add('placeholder');

                if ((isRolling || isRedoingRollAfterPrice) && currentExpertiseDieOriginalIndex === currentRollIndex && currentAnimatedValue !== null) {
                    content = currentAnimatedValue;
                    dieFaceDiv.classList.remove('placeholder', 'waiting', 'filled-placeholder');
                    if (currentAnimatedValue === 6) dieFaceDiv.classList.add('success', 'animating');
                    else if (currentAnimatedValue === 1) dieFaceDiv.classList.add('failure', 'animating');
                    else if (currentAnimatedValue >= 4) dieFaceDiv.classList.add('partial-success', 'animating');
                    else dieFaceDiv.classList.add('partial-failure', 'animating');
                } else if (rolls[currentExpertiseDieOriginalIndex] !== undefined) {
                    content = rolls[currentExpertiseDieOriginalIndex];
                    dieFaceDiv.classList.remove('placeholder', 'waiting', 'filled-placeholder');
                    if (rolls[currentExpertiseDieOriginalIndex] === 6) dieFaceDiv.classList.add('success');
                    else if (rolls[currentExpertiseDieOriginalIndex] === 1) dieFaceDiv.classList.add('failure');
                    else if (rolls[currentExpertiseDieOriginalIndex] >= 4) dieFaceDiv.classList.add('partial-success');
                    else dieFaceDiv.classList.add('partial-failure');
                } else if (isRolling || isRedoingRollAfterPrice) {
                    dieFaceDiv.classList.add("waiting");
                } else {
                    dieFaceDiv.classList.add("filled-placeholder");
                }
                dieFaceDiv.innerHTML = content;
                slotDiv.appendChild(dieFaceDiv);

                if (playerForExpertise) {
                    const indicator = document.createElement('div');
                    indicator.classList.add('player-indicator');
                    indicator.title = `Expertise from ${playerForExpertise.name}`;
                     if (playerForExpertise.image) {
                        const imgPlayerIndicator = document.createElement('img');
                        imgPlayerIndicator.src = playerForExpertise.image;
                        imgPlayerIndicator.alt = playerForExpertise.name;
                        indicator.appendChild(imgPlayerIndicator);
                    } else {
                        indicator.classList.add('generic');
                        indicator.textContent = playerForExpertise.name.charAt(0).toUpperCase();
                        indicator.style.backgroundColor = playerForExpertise.color;
                    }
                    slotDiv.appendChild(indicator);
                }
                dicePoolDisplayEl.appendChild(slotDiv);
            }
            if (pushedLuckDieRoll !== null && !isRolling && !isRedoingRollAfterPrice) {
                const pushedDieSlot = document.createElement('div');
                pushedDieSlot.classList.add('dice-slot', 'filled');
                pushedDieSlot.style.borderColor = '#f1c40f';
                const dieFaceDiv = document.createElement('div');
                dieFaceDiv.classList.add('die-face', 'pushed-luck-die');
                 if (pushedLuckDieRoll <= 3) dieFaceDiv.classList.add('failure'); else dieFaceDiv.classList.add('success');
                dieFaceDiv.textContent = pushedLuckDieRoll;
                pushedDieSlot.appendChild(dieFaceDiv);
                dicePoolDisplayEl.appendChild(pushedDieSlot);
            }
        }

        function renderPlayerList() {
            playerListEl.innerHTML = '';
            noPlayersTextEl.style.display = players.length === 0 ? 'block' : 'none';
            players.forEach(player => {
                const playerItemDiv = document.createElement('div');
                playerItemDiv.classList.add('player-item');
                const playerInfoDiv = document.createElement('div');
                playerInfoDiv.classList.add('player-info');
                const avatarContainer = document.createElement('div');
                avatarContainer.classList.add('player-avatar-container');
                if (player.image) {
                    const img = document.createElement('img');
                    img.src = player.image; img.alt = player.name; img.classList.add('player-avatar-img');
                    avatarContainer.appendChild(img);
                } else {
                    const initialDiv = document.createElement('div');
                    initialDiv.classList.add('player-initial-avatar');
                    initialDiv.textContent = player.name.charAt(0).toUpperCase();
                    initialDiv.style.backgroundColor = player.color;
                    avatarContainer.appendChild(initialDiv);
                }
                playerInfoDiv.appendChild(avatarContainer);
                const nameLabel = document.createElement('span');
                nameLabel.classList.add('player-name-label'); nameLabel.textContent = player.name;
                playerInfoDiv.appendChild(nameLabel);
                playerItemDiv.appendChild(playerInfoDiv);
                const actionIconsDiv = document.createElement('div');
                actionIconsDiv.classList.add('player-action-icons');
                const addExpertiseBtn = document.createElement('button');
                addExpertiseBtn.classList.add('player-action-btn'); addExpertiseBtn.innerHTML = DICE_ICON;
                addExpertiseBtn.title = `Add Expertise (${player.contributedDice}/3)`;
                addExpertiseBtn.disabled = player.contributedDice >= 3 || isRolling || canPushLuck || canPayPrice || isRedoingRollAfterPrice || hasRolledThisTurn;
                addExpertiseBtn.addEventListener('click', () => handlePlayerContributesExpertise(player.id));
                actionIconsDiv.appendChild(addExpertiseBtn);
                const addSpecialMoveBtn = document.createElement('button');
                addSpecialMoveBtn.classList.add('player-action-btn'); addSpecialMoveBtn.innerHTML = STAR_ICON;
                addSpecialMoveBtn.title = `Add Special Move`;
                const numSMCovers = getNumSpecialMovesVisuallyCoveringSlots();
                addSpecialMoveBtn.disabled = (difficulty > 0 && numSMCovers >= difficulty) || isRolling || canPushLuck || canPayPrice || isRedoingRollAfterPrice || hasRolledThisTurn;
                addSpecialMoveBtn.addEventListener('click', () => handlePlayerContributesSpecialMove(player.id));
                actionIconsDiv.appendChild(addSpecialMoveBtn);
                playerItemDiv.appendChild(actionIconsDiv);
                playerListEl.appendChild(playerItemDiv);
            });
        }

        function updateStatusMessage() {
            let msg = "Ready to roll!";
            const numSMCovers = getNumSpecialMovesVisuallyCoveringSlots();
            const numPrimarySlotsNeeded = getNumPrimarySlotsForExpertiseOrEmpty();
            const currentDicePool = getDicePool();

            if (isRolling && !isRedoingRollAfterPrice) {
                msg = "Rolling dice...";
            } else if (isRedoingRollAfterPrice) {
                msg = `Redo the roll of 1! (Price: ${outcomeText.split("Price Paid: ")[1]?.split(". Redo")[0] || 'Paid'})`;
            } else if (canPushLuck) {
                msg = `A 6! Push your luck? Or Reset.`;
            } else if (canPayPrice) {
                 msg = `A 1! Pay a price to redo this die and continue? Or Reset.`;
            } else if (outcomeText) {
                msg = outcomeText;
                 if (rolls.length > 0 && !isRolling && !isRedoingRollAfterPrice) {
                     msg += ` (XP: ${rolls.length * 10})`;
                     if(pushedLuckDieRoll !== null) msg += ` (Pushed Luck Die: ${pushedLuckDieRoll})`;
                 }
            } else if (currentDicePool === 0 && difficulty > 0 && numSMCovers < difficulty) {
                msg = `Add expertise dice to attempt Difficulty ${difficulty}.`;
            } else if (expertise < numPrimarySlotsNeeded) {
                const needed = numPrimarySlotsNeeded - expertise;
                msg = `Need ${needed} more expertise ${needed === 1 ? 'die' : 'dice'} to cover Difficulty ${difficulty}.`;
            }
            statusMessageEl.textContent = msg;
        }

        function updateActionButtons() {
            const currentDicePool = getDicePool();
            const numSMCovers = getNumSpecialMovesVisuallyCoveringSlots();

            rollDiceBtn.classList.remove('roll-mode', 'reset-mode');

            if (hasRolledThisTurn && !isRolling && !isRedoingRollAfterPrice) {
                rollDiceBtn.textContent = "Reset & Prepare Next Roll";
                rollDiceBtn.disabled = false;
                rollDiceBtn.classList.add('reset-mode');
            } else if (isRedoingRollAfterPrice) {
                rollDiceBtn.textContent = "Redo Failed Roll";
                rollDiceBtn.disabled = isRolling;
                rollDiceBtn.classList.add('roll-mode');
            } else {
                rollDiceBtn.textContent = isRolling ? "Rolling..." : "Roll Dice";
                rollDiceBtn.disabled =
                    (difficulty > 0 && currentDicePool === 0 && numSMCovers < difficulty) ||
                    isRolling ||
                    expertise < getNumPrimarySlotsForExpertiseOrEmpty();
                rollDiceBtn.classList.add('roll-mode');
            }
            pushLuckBtn.style.display = canPushLuck ? 'inline-block' : 'none';
            payPriceBtn.style.display = canPayPrice ? 'inline-block' : 'none';
        }

        function updateDifficultyDisplay() {
            difficultyDisplay.textContent = difficulty;
        }

        function determineSingleDieOpportunity(die) {
             if (!canPushLuck && !canPayPrice) {
                if (die === 6) {
                    canPushLuck = true;
                } else if (die === 1) {
                    canPayPrice = true;
                }
             }
        }

        function finalizeOverallOutcome(diceArray) {
            outcomeText = "";
            if (isTensionTimerRunning) {
                stopAndClearTensionTimer();
            }

            if (canPushLuck || canPayPrice || isRedoingRollAfterPrice || pushedLuckDieRoll !== null) {
                 if(!canPushLuck && !canPayPrice && !isRedoingRollAfterPrice && pushedLuckDieRoll !== null) {
                 } else {
                    return;
                 }
            }

             if (diceArray.length === 0 && getDicePool() === 0 && getNumSpecialMovesVisuallyCoveringSlots() >= difficulty && difficulty > 0) {
                 outcomeText = "Success! Difficulty covered by special moves, no roll needed.";
                 return;
             }

             if (diceArray.length === 0 && getDicePool() === 0 && !(getNumSpecialMovesVisuallyCoveringSlots() >= difficulty && difficulty > 0)) {
                if (hasRolledThisTurn) {
                   outcomeText = "No dice rolled. Outcome determined by situation or requires dice."; return;
                } else {
                    return;
                }
             }

             if (diceArray.length === 0) return;

            const highest = Math.max(...diceArray);
            if (highest === 6 && !diceArray.includes(1)) outcomeText = "Success! The goal is achieved, cleanly.";
            else if (highest === 6 && diceArray.includes(1)) outcomeText = "Critical Success with a major complication (6 and 1)!";
            else if (highest === 1) outcomeText = "Failure! Face consequences, loss, or harm.";
            else if (highest <= 3) outcomeText = "Failure with a silver lining (2-3)";
            else outcomeText = "Success with a complication (4-5)";

            if (countdownClock > 0 && !isRedoingRollAfterPrice && !canPushLuck && !canPayPrice) {
                countdownClock--;
            }
        }

        function fullUIUpdate() {
            updateDifficultyDisplay();
            renderDicePool();
            renderPlayerList();
            updateActionButtons();
            updateStatusMessage();
            updateTensionTimerDisplay();
            updateCountdownDisplay();
        }

        function handleImageUploadJS(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => { uploadedImage = e.target.result; imagePreviewEl.src = uploadedImage; imagePreviewContainer.style.display = 'block'; };
                reader.readAsDataURL(file);
            } else {
                uploadedImage = null;
                imagePreviewContainer.style.display = 'none';
                imagePreviewEl.src = "#";
            }
        }

        function addPlayerJS() {
            const name = playerNameInput.value.trim();
            if (name) {
                players.push({
                    id: Date.now(), name, image: uploadedImage,
                    contributedDice: 0, contributedSpecialMoves: 0,
                    color: generatePlayerColor()
                });
                playerNameInput.value = ''; playerImageInput.value = ''; uploadedImage = null;
                imagePreviewContainer.style.display = 'none'; imagePreviewEl.src = "#";
                addPlayerModalEl.style.display = 'none';
                fullUIUpdate();
            } else { alert("Player name is required."); }
        }

        function handlePlayerContributesExpertise(playerId) {
            if (hasRolledThisTurn || isRolling || canPushLuck || canPayPrice || isRedoingRollAfterPrice) return;
            const playerIndex = players.findIndex(p => p.id === playerId);
            if (playerIndex === -1) return;
            if (players[playerIndex].contributedDice < 3) {
                players[playerIndex].contributedDice += 1;
                diceContributions.push(playerId); expertise += 1;
                fullUIUpdate();
            } else { alert(`${players[playerIndex].name} has reached the maximum of 3 expertise contributions.`); }
        }

        function handlePlayerContributesSpecialMove(playerId) {
             if (hasRolledThisTurn || isRolling || canPushLuck || canPayPrice || isRedoingRollAfterPrice) return;
            const playerIndex = players.findIndex(p => p.id === playerId);
            if (playerIndex === -1) return;
            const numSMCovers = getNumSpecialMovesVisuallyCoveringSlots();
            if (difficulty > 0 && numSMCovers >= difficulty) {
                alert("All difficulty slots are already covered by special moves."); return;
            }
            players[playerIndex].contributedSpecialMoves += 1;
            specialMoveContributions.push(playerId); specialMoves += 1;
            fullUIUpdate();
        }

        function clearAllContributionsAndStatsJS() {
            players.forEach(p => { p.contributedDice = 0; p.contributedSpecialMoves = 0; });
            diceContributions = []; specialMoveContributions = [];
            expertise = 0; specialMoves = 0;
            rolls = []; outcomeText = "";
            isRolling = false; hasRolledThisTurn = false;
            currentRollIndex = null; currentAnimatedValue = null;

            if (sequenceChainTimeoutId) clearTimeout(sequenceChainTimeoutId);
            sequenceChainTimeoutId = null;

            canPushLuck = false; canPayPrice = false;
            pushedLuckDieRoll = null; isRedoingRollAfterPrice = false;
            indexOfRollToRedo = -1;
            currentSequenceTotalDice = 0;

            stopAndClearTensionTimer();
            fullUIUpdate();
        }

        function handlePushLuck() {
            if (!canPushLuck) return;
            if (sequenceChainTimeoutId) clearTimeout(sequenceChainTimeoutId);
            sequenceChainTimeoutId = null;
            pushedLuckDieRoll = Math.floor(Math.random() * 6) + 1;
            canPushLuck = false;
            if (pushedLuckDieRoll <= 3) {
                outcomeText = "Push Your Luck Failed! Original success potentially undone, complication added.";
            } else {
                outcomeText = "Push Your Luck Succeeded! Advantage pressed further.";
            }
            if (pushedLuckDieRoll === 6 && countdownClock < 99) {
                 countdownClock++;
                 outcomeText += " (+1 to Countdown Clock)";
            } else if (pushedLuckDieRoll === 1 && countdownClock > 0) {
                 countdownClock--;
                 outcomeText += " (-1 to Countdown Clock)";
            }
            isRolling = false;
            hasRolledThisTurn = true;
            fullUIUpdate();
        }

         function handlePayPrice() {
            if (!canPayPrice) return;
            const pricePaidDescription = prompt("Describe the price you pay (e.g., lose supplies, take stress, alert enemies):");
            if (pricePaidDescription === null) return;
            if (pricePaidDescription.trim() === "") {
                alert("You must describe a price to pay.");
                return;
            }
            if (sequenceChainTimeoutId) clearTimeout(sequenceChainTimeoutId);
            sequenceChainTimeoutId = null;
            canPayPrice = false;
            isRedoingRollAfterPrice = true;
            if(indexOfRollToRedo === -1) {
                 alert("Error: Could not identify which roll to redo. Resetting.");
                 clearAllContributionsAndStatsJS();
                 return;
            }
            outcomeText = `Price Paid: ${pricePaidDescription}. Redo the roll of 1.`;
            pushedLuckDieRoll = null;
            isRolling = false;
            fullUIUpdate();
        }

        function startRollingJS() {
            if (rollDiceBtn.classList.contains('reset-mode')) {
                clearAllContributionsAndStatsJS();
                return;
            }

            if (isTensionTimerRunning) {
                haltTensionTimer();
            }

            if (isRedoingRollAfterPrice) {
                if (indexOfRollToRedo === -1) {
                    alert("Error: Cannot redo roll, index invalid.");
                    isRedoingRollAfterPrice = false; fullUIUpdate(); return;
                }
                isRolling = true;
                outcomeText = "";
                currentAnimatedValue = null;
                currentRollIndex = indexOfRollToRedo;
                renderDicePool();
                let animationCounter = 0;
                const animationIntervalId = setInterval(() => {
                    currentAnimatedValue = Math.floor(Math.random() * 6) + 1;
                    renderDicePool();
                    animationCounter++;
                    if (animationCounter >= SINGLE_DIE_ANIMATION_FRAMES) {
                        clearInterval(animationIntervalId);
                        const newDieRoll = Math.floor(Math.random() * 6) + 1;
                        rolls[indexOfRollToRedo] = newDieRoll;
                        currentAnimatedValue = newDieRoll;
                        renderDicePool();
                        if (newDieRoll === 6 && countdownClock < 99) countdownClock++;
                        else if (newDieRoll === 1 && countdownClock > 0) countdownClock--;
                        const redoDisplayPauseTimeout = setTimeout(() => {
                            currentAnimatedValue = null;
                            isRolling = false;
                            isRedoingRollAfterPrice = false;
                            determineSingleDieOpportunity(newDieRoll);
                            if (canPushLuck || canPayPrice) {
                                hasRolledThisTurn = true;
                                if(canPayPrice) indexOfRollToRedo = currentRollIndex;
                                fullUIUpdate();
                            } else {
                                const dieSlotThatWasRedone = indexOfRollToRedo;
                                indexOfRollToRedo = -1;
                                outcomeText = "";
                                const nextDieInOriginalSequence = dieSlotThatWasRedone + 1;
                                if (nextDieInOriginalSequence < currentSequenceTotalDice) {
                                    isRolling = true;
                                    fullUIUpdate();
                                    sequenceChainTimeoutId = setTimeout(() => {
                                        if(isRolling) {
                                            processNextDieInSequence(nextDieInOriginalSequence, currentSequenceTotalDice);
                                        }
                                    }, SINGLE_DIE_POST_ANIMATION_PAUSE / 2);
                                } else {
                                    finalizeOverallOutcome(rolls);
                                    hasRolledThisTurn = true;
                                    fullUIUpdate();
                                }
                            }
                        }, SINGLE_DIE_POST_ANIMATION_PAUSE);
                    }
                }, SINGLE_DIE_ANIMATION_INTERVAL);
                return;
            }
            const currentDicePool = getDicePool();
            const numSMCovers = getNumSpecialMovesVisuallyCoveringSlots();
             if (currentDicePool === 0) {
                if (difficulty > 0 && numSMCovers >= difficulty) {
                     outcomeText = "Success! Difficulty covered by special moves, no roll needed.";
                     finalizeOverallOutcome([]);
                     hasRolledThisTurn = true;
                } else if (difficulty > 0 && numSMCovers < difficulty) {
                    outcomeText = "Cannot roll: Need more expertise or special moves for this difficulty.";
                    hasRolledThisTurn = false;
                } else {
                    outcomeText = "Difficulty is 0, automatic success assumed. No roll needed.";
                     finalizeOverallOutcome([]);
                     hasRolledThisTurn = true;
                }
                isRolling = false; fullUIUpdate(); return;
            }
            if (expertise < getNumPrimarySlotsForExpertiseOrEmpty()) {
                outcomeText = `Cannot roll: Need ${getNumPrimarySlotsForExpertiseOrEmpty() - expertise} more expertise.`;
                hasRolledThisTurn = false;
                isRolling = false; fullUIUpdate(); return;
            }
            rolls = [];
            for(let i=0; i < currentDicePool; ++i) rolls.push(undefined);
            outcomeText = "";
            canPushLuck = false; canPayPrice = false; pushedLuckDieRoll = null;
            if (sequenceChainTimeoutId) clearTimeout(sequenceChainTimeoutId);
            sequenceChainTimeoutId = null;
            isRolling = true; hasRolledThisTurn = false;
            currentRollIndex = 0;
            currentAnimatedValue = null;
            currentSequenceTotalDice = currentDicePool;
            fullUIUpdate();
            processNextDieInSequence(0, currentSequenceTotalDice);
        }

        function processNextDieInSequence(rollIdx, totalDiceInPool) {
            if (!isRolling) {
                if (sequenceChainTimeoutId) clearTimeout(sequenceChainTimeoutId);
                sequenceChainTimeoutId = null;
                return;
            }
            if (canPushLuck || canPayPrice) {
                isRolling = false;
                hasRolledThisTurn = true;
                fullUIUpdate();
                return;
            }
            currentRollIndex = rollIdx;
            currentAnimatedValue = null;
            renderDicePool();
            let animationCounter = 0;
            const animationIntervalId = setInterval(() => {
                if (!isRolling) {
                    clearInterval(animationIntervalId);
                    return;
                }
                currentAnimatedValue = Math.floor(Math.random() * 6) + 1;
                renderDicePool();
                animationCounter++;
                if (animationCounter >= SINGLE_DIE_ANIMATION_FRAMES) {
                    clearInterval(animationIntervalId);
                    const currentDieRoll = Math.floor(Math.random() * 6) + 1;
                    rolls[rollIdx] = currentDieRoll;
                    currentAnimatedValue = currentDieRoll;
                    renderDicePool();
                    if (currentDieRoll === 6 && countdownClock < 99) {
                        countdownClock++;
                    } else if (currentDieRoll === 1 && countdownClock > 0) {
                        countdownClock--;
                    }
                    const postAnimationPauseTimeout = setTimeout(() => {
                        if (!isRolling && !(canPushLuck || canPayPrice)) {
                             currentAnimatedValue = null; renderDicePool(); return;
                        }
                        currentAnimatedValue = null;
                        renderDicePool();
                        determineSingleDieOpportunity(currentDieRoll);
                        if (canPushLuck || canPayPrice) {
                            isRolling = false;
                            hasRolledThisTurn = true;
                            if (canPayPrice) {
                                indexOfRollToRedo = rollIdx;
                            }
                            fullUIUpdate();
                            return;
                        }
                        const isLastDieInSequence = (rollIdx + 1) >= totalDiceInPool;
                        if (isLastDieInSequence) {
                            isRolling = false;
                            currentRollIndex = null;
                            finalizeOverallOutcome(rolls);
                            hasRolledThisTurn = true;
                            fullUIUpdate();
                        } else {
                            const delayForNextDie = BASE_DELAY_AFTER_DIE_FINISHES + (rollIdx * DELAY_INCREMENT_PER_DIE);
                            sequenceChainTimeoutId = setTimeout(() => {
                                if (isRolling) {
                                    processNextDieInSequence(rollIdx + 1, totalDiceInPool);
                                }
                            }, delayForNextDie);
                        }
                    }, SINGLE_DIE_POST_ANIMATION_PAUSE);
                }
            }, SINGLE_DIE_ANIMATION_INTERVAL);
        }

        decreaseDifficultyBtn.addEventListener('click', () => {
            if (!isRolling && !hasRolledThisTurn && !canPushLuck && !canPayPrice) {
                difficulty = Math.max(0, difficulty - 1);
                fullUIUpdate();
            }
        });
        increaseDifficultyBtn.addEventListener('click', () => {
            if (!isRolling && !hasRolledThisTurn && !canPushLuck && !canPayPrice) {
                difficulty += 1;
                fullUIUpdate();
            }
        });

        durationButtons.forEach(button => {
            button.addEventListener('click', () => {
                const duration = parseInt(button.dataset.duration, 10);
                startTensionTimerInternalLogic(duration);
                durationButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
            });
        });

        decreaseCountdownBtn.addEventListener('click', () => adjustCountdownClock(-1));
        increaseCountdownBtn.addEventListener('click', () => adjustCountdownClock(1));
        countdownDenominatorInputEl.addEventListener('change', handleDenominatorChange);
        countdownDenominatorInputEl.addEventListener('input', (e) => {
            if (e.target.value === "" && !isRolling && !hasRolledThisTurn) {
                return;
            }
            const val = parseInt(e.target.value);
            if (isNaN(val) && e.target.value !== "") {
                e.target.value = countdownClockDenominator;
            } else if (val > 20) {
                e.target.value = 20;
            } else if (val < 1 && e.target.value !== "") {
                e.target.value = 1;
            }
        });


        openAddPlayerModalBtn.addEventListener('click', () => { addPlayerModalEl.style.display = 'flex'; });
        cancelAddPlayerBtn.addEventListener('click', () => {
            addPlayerModalEl.style.display = 'none'; playerNameInput.value = ''; playerImageInput.value = '';
            uploadedImage = null; imagePreviewContainer.style.display = 'none'; imagePreviewEl.src = '#';
        });
        confirmAddPlayerBtn.addEventListener('click', addPlayerJS);
        playerImageInput.addEventListener('change', handleImageUploadJS);
        rollDiceBtn.addEventListener('click', startRollingJS);
        pushLuckBtn.addEventListener('click', handlePushLuck);
        payPriceBtn.addEventListener('click', handlePayPrice);

        setTimeout(() => {
            calculateTensionTimerSvgBorderPerimeter();
            fullUIUpdate();
        }, 200);
    });
  </script>

<!-- The rulebook HTML content, as provided, follows here -->
<div id="rulebookDisplaySection" style="padding-top: 40px; padding-bottom: 40px;">
    <div class="container">
        <h1>Expertise Engine</h1>
        <p class="subtitle">by QuestWorks</p>

        <p>A professional development-themed tabletop RPG where your expertise shapes every action. Each character has a <span class="accent">HeroType</span> with three unique <span class="accent">Areas of Expertise</span> that define how they solve problems.</p>

        <p>Just like in the real world, success in Expertise Engine comes from knowing how to apply your expertise and work with others. It's about:</p>

        <ul>
          <li>Learning when and how to use your professional skills</li>
          <li>Figuring out when to lead and when to support</li>
          <li>Growing beyond your comfort zone</li>
          <li>Building trust and taking smart risks together</li>
          <li>Finding creative ways to solve problems</li>
        </ul>

    <h2>How to Play</h2>
    <p>You can do anything that suits your character and comes to mind—fight, persuade, avoid danger, share your expertise, search for clues, etc. But you'll probably have to roll the dice!</p>

    <div class="note">
      <strong>NOTE:</strong> Expertise Engine always uses six-sided dice.
    </div>

    <h2>Rolling Dice</h2>

    <h3>Step 1: Declare your action</h3>
    <p>Think about what your character is good at, and what they would do in this situation. Then ask, how big of a risk do I want to take? The more risky or challenging the task, the more dice you'll be required to roll. You can act alone or strategize as a team. First, pick a goal and general intent.</p>

    <div class="note">
      <strong>NOTE:</strong> Risk is contextual. The same goal may be harder or easier depending on your HeroType, the environment, your level, and what's already happened in the story.
    </div>

    <hr>
    <h3>Step 2: Quest Guide sets the difficulty</h3>
    <p>The Quest Guide sets a difficulty level between 1–9+ dice: 1 being trivial, and 9+ being near impossible. This number represents how much luck it'll take to succeed.</p>

    <div class="note">
      <strong>NOTE:</strong> Creating a favorable context with lower-risk moves first (distracting the guards, tossing a smoke bomb, breaking in at night) makes tasks that would be quite difficult (like silently taking out a target) much easier.
    </div>
    <p>
      <strong>GM Tip:</strong> Narrate your difficulty decisions aloud by stacking context clues. This helps players follow your logic and get better at estimating risk.</p>

      <p><em>Example:</em></p>
      <blockquote>
        "You're trying to cross a frozen bridge under fire? The wind is brutal, the bridge is unstable, and there's an archer firing at you from the cliffs. Sounds like 4 dice."
      </blockquote>

    <hr>

    <h3>Step 3: Ready your roll</h3>
    <p>Now it's time to strategize. You <strong>must</strong> roll enough dice to match or exceed the difficulty. You cannot roll if you don't. You can do this by:</p>
    <ul>
      <li><strong>Applying expertise</strong>—each expertise used adds 1 die, as long as it clearly applies. Each expertise can be used once per action. Get creative!</li>
      <li><strong>Triggering special moves</strong>—each one reduces the difficulty by 1—but you must leave at least 1 die to roll.</li>
    </ul>

    <div class="note">
      <strong>NOTE:</strong> You can always roll extra expertise dice to earn more XP—but each die adds risk.
    </div>

    <h3>Step 3.5: Get help or scale back</h3>
    <ul>
    <p>Can't meet the difficulty?</p>
      <li>The team can add more expertise dice, or reduce difficulty by applying special moves</li>
      <li>Adjust the goal to lessen the risk and lower the difficulty.</li>
      <li>Create better conditions first—set a trap, make a distraction, scout ahead. Then come back and crush it.</li>
    </ul>

    <div class="note">
      <strong>NOTE:</strong> Only dice in the pool can earn XP, so special moves don't.
    </div>

    <h3>Step 4: Roll the dice and resolve</h3>
    <p>Once you decide to roll, the pool is locked, and all dice must be rolled sequentially in the order they were committed. Stop rolling right away when a 6 or a 1 is rolled.</p>
    <ul>
        <li><strong>6:</strong> Success—the goal is achieved, cleanly</li>
        <li><strong>1:</strong> Failure—face consequences, loss, or harm</li>
        <li><strong>2–5s only:</strong> Look to the highest result</li>
        <ul>
            <li><strong>2–3:</strong> Failure with a silver lining</li>
            <li><strong>4–5:</strong> Success with a complication</li>
        </ul>
    </ul>

    <div class="note">
      <strong>NOTE:</strong> More dice means more chances for a higher result—but also more chances for a 1!
    </div>

    <p><strong>XP:</strong> Each player gains 10 XP for each die they personally rolled. Dice that aren't rolled due to a 6 or 1 don't grant XP.</p>
    <p>All helpers share in both the outcome and the risk, even if they only contributed special moves.</p>

    <h3>Pacing</h3>
    <p>To keep things tense, the Quest Guide may set a <strong>Countdown Clock</strong>—a limit on how many <em>actions</em> the party can take before something big happens. This helps incentivize players to take higher-risk actions.</p>
    <p><em>Example:</em> You have 6 rolls before the cult finishes their ritual. Rolling a lucky 6 could extend the clock, while a 1 could speed it up.</p>

    <p>In addition, every roll is governed by a <strong>Tension Timer</strong>—a tool for managing pacing and introducing time-based challenges. The timer adds urgency and pressure to player decisions by providing a limited window to:</p>
    <ul>
      <li><strong>React</strong> to a situation (30 seconds - shortest duration)</li>
      <li><strong>Sync</strong> efforts or make a quick collective decision (60 seconds - medium duration)</li>
      <li><strong>Plan</strong> next moves more thoroughly (90 seconds - longest duration)</li>
    </ul>
    <p>The Quest Guide sets the timer as soon as the situation is described. Within the allotted time, players must declare their intent, learn the difficulty, AND build their dice pool. If they fail to complete all steps before time runs out, the action fails automatically.</p>

        <h2>Beyond Failure & Success</h2>
        <p>Once per session, you may do the following:</p>
        <p><strong>Push Your Luck:</strong> After rolling a 6, you can roll another die to press your advantage—but risk undoing your success if you fail.</p>
        <p><strong>Pay a Price:</strong> If a 1 is rolled, you can pay a price to avoid the instant failure and continue rolling. Pay a price by sacrificing something important to you that fits the context—like your supplies, your reputation, or extra health.</p>


        <h2>Combat & Health</h2>
        <p>Combat is simple and high-stakes. Describe what you're trying to do (gain a tactical advantage, disarm, wound, decapitate, etc.) and the Quest Guide will set the difficulty—just like any other action.
    <br><br>
        Enemies are defeated when it makes sense to the Quest Guide that they would be, and they deal as much damage to players as makes sense to the Quest Guide considering the context, their might, and the player's roll results. 1 damage for glancing blows, up to 6 damage for beyond-lethal ones.</p>

    <div class="note">
      <strong>NOTE:</strong> This system doesn't use stat modifiers or numerical penalties to rolls. Damage is tracked through health and armor. Any consequences beyond that are fictional—like being separated, disarmed, or stuck—until you recover or regroup.
    </div>


        <div>
          <h3>Armor</h3>
          <p>Armor can absorb damage, point for point. When it runs out, your health is at risk. Damaged armor is useless until it is repaired.</p>

              <div class="note">
          <strong>NOTE:</strong> Opponents and NPCs never roll. Only players do.
        </div>

    <h3>Defeat</h3>
    <p>At 0 HP, you're temporarily out of action—with lasting consequences to your wellbeing. Recovery requires proper rest or healing.</p>

    <p>You have two options instead of simply being knocked out:</p>

    <p><strong>Last Stand:</strong> When you hit 0 HP, you may immediately succeed at a final heroic action of medium difficulty before you're knocked out. Choose one of your expertise to fuel the move—it becomes completely unavailable until you complete a quest to restore it. No roll required.</p>

    <p><strong style="color:darkred;">A Hero's Death (Level 7+):</strong> If your character is level 7 or higher, you may choose death. In exchange for the ultimate sacrifice, you succeed at an impossible task—something no combination of rolls, moves, or strategy could have accomplished. The cost: your character dies permanently, and you'll start over with a brand-new character at level 1.</p>


        <h2>Edge</h2>
        <p>Each character has one of these Edges, granting a once-per-session special move:</p>
        <ul>
          <li><strong>Plotter:</strong> "I already planned for this."</li>
          <li><strong>Crafter:</strong> "I can make a gadget for this…"</li>
          <li><strong>Driver:</strong> "I beat them to it!"</li>
          <li><strong>Spotter:</strong> "I know a better way…"</li>
        </ul>

        <h2>Downtime & Character Development</h2>
        <p>When characters have significant downtime, they can <strong>switch</strong> certain abilities. You can only have one talent, specialty, weapon, etc. at a time—this isn't learning new options, it's shifting focus:</p>
        <ul>
          <li><strong>Rogues</strong> can switch their roguish talent</li>
          <li><strong>Vanguards</strong> can retrain with a different signature weapon</li>
          <li><strong>Mavericks</strong> can shift their destructive vice</li>
          <li><strong>Saints</strong> can recommit to a different deity</li>
          <li><strong>Magisters</strong> can switch their magic specialty</li>
          <li><strong>Charmers</strong> can switch their arcane art form</li>
          <li><strong>Wardens</strong> can embrace a different virtue</li>
          <li><strong>Rangers</strong> can bond with a different animal companion</li>
          <li><strong>Mystics</strong> can attune to a new element</li>
        </ul>
        <p>How they accomplish this is up to the players and Quest Guide—whether through training, study, reflection, life experiences, or other meaningful character moments.</p>

        <h2>Character Sheets</h2>

        <!-- The Rogue -->
        <div class="character-sheet">
          <h3>The Rogue</h3>

          <h4>Basic Information</h4>
          <ul>
            <li><strong>Name:</strong> Enter your info</li>
            <li><strong>Level:</strong> 1</li>
            <li><strong>Health:</strong> 3 points </li>
          </ul>

          <h4>Areas of Expertise</h4>
          <div class="expertise-area">
            <strong>1. Finesse</strong>
            <p><em>Sneaking, acrobatics, lockpicking, sleight of hand, precise strikes, careful words—when delicate touch beats brute force. You're agile and have killer reflexes.</em></p>
          </div>
          <div class="expertise-area">
            <strong>2. Insight</strong>
            <p><em>Assessing situations, finding weak points, spotting traps, spying, identifying patterns—you see opportunities that others miss.</em></p>
          </div>
          <div class="expertise-area">
            <strong>3. Adaptability</strong>
            <p><em>Street smarts. Blending in. Manipulating situations. Doing things that have never been done before.</em></p>
          </div>

          <h4>Special Moves</h4>
          <ul>
            <li>
              <strong>Roguish Talent:</strong> Choose one talent (use this during play):
              <div class="dropdown">
                <select name="roguish-talent">
                  <option value="" disabled selected>Select a Talent</option>
                  <option value="Sneaking">Sneaking</option>
                  <option value="Lying">Lying</option>
                  <option value="Climbing">Climbing</option>
                  <option value="Stealing">Stealing</option>
                </select>
              </div>
            </li>
            <li>
              <strong>Mastermind:</strong> When a teammate follows a plan you set up during a heist, infiltration, or sabotage.
            </li>
            <li>
              <strong>Backstab:</strong> When you attack from the shadows.
            </li>
          </ul>

          <h4>Gear</h4>
          <h5>Equipment</h5>
          <ul class="equipment-list">
            <li>Leather Armor (1 armor points)</li>
            <li>Twin Daggers</li>
            <li>3 Throwing Knives (Restock as needed)</li>
            <li>Adventure Gear: 5 uses (e.g., rope, tools, etc.)</li>
          </ul>
          <h5>Inventory</h5>
          <div class="text-input">
            <input type="text" name="inventory" placeholder="Write down items you pick up here">
          </div>
          <h5>Journal</h5>
          <div class="text-input">
            <input type="text" name="journal" placeholder="Notes, observations, plans">
          </div>
        </div>

        <!-- The Mystic -->
        <div class="character-sheet">
          <h3>The Mystic</h3>

          <h4>Basic Information</h4>
          <ul>
            <li><strong>Name:</strong> Enter your info</li>
            <li><strong>Level:</strong> 1</li>
            <li><strong>Health:</strong> 3 points </li>
            <li><strong>Regeneration:</strong> In combat, you can use a turn to regenerate one health.</li>
          </ul>

          <h4>Areas of Expertise</h4>
          <div class="expertise-area">
            <strong>1. Connection</strong>
            <p><em>You are inextricably linked to all of nature—flora, fauna, and fungi.</em></p>
          </div>
          <div class="expertise-area">
            <strong>2. Balance</strong>
            <p><em>You understand how everything fits together—people, ideas, places, environments.</em></p>
          </div>
          <div class="expertise-area">
            <strong>3. Flow</strong>
            <p><em>Change, energy, and transformation. You are one with it.</em></p>
          </div>

          <h4>Special Moves</h4>
          <ul>
            <li>
              <strong>Elemental Affinity:</strong> When you connect to your element:
              <div class="dropdown">
                <select name="elemental-affinity">
                  <option value="" disabled selected>Choose your element</option>
                  <option value="earth">Earth — stone, soil, plants, stability</option>
                  <option value="water">Water — flow, adaptation, healing</option>
                  <option value="air">Air — wind, freedom, change</option>
                  <option value="fire">Fire — passion, transformation, destruction/renewal</option>
                </select>
              </div>
            </li>
            <li>
              <strong>Animal Whisperer:</strong> When you want to speak with an animal.
            </li>
            <li>
              <strong>Shape Shift:</strong> When you turn into a non-magical animal and act in a way that suits that form.
            </li>
          </ul>

          <h4>Gear</h4>
          <h5>Equipment</h5>
          <ul class="equipment-list">
            <li>Robes - No Armor Points</li>
            <li>Steel-Pointed Staff</li>
            <li>Herbs: 5 uses (heals 1 point of health per use)</li>
          </ul>
          <h5>Inventory</h5>
          <div class="text-input">
            <input type="text" name="inventory" placeholder="Write down items you pick up here">
          </div>
          <h5>Journal</h5>
          <div class="text-input">
            <input type="text" name="journal" placeholder="Notes, observations, plans">
          </div>
        </div>

        <!-- The Ranger -->
        <div class="character-sheet">
          <h3>The Ranger</h3>

          <h4>Basic Information</h4>
          <ul>
            <li><strong>Name:</strong> Enter your info</li>
            <li><strong>Level:</strong> 1</li>
            <li><strong>Health:</strong> 3 points</li>
          </ul>

          <h4>Animal Companion</h4>
          <div class="text-input">
            <input type="text" name="animal-companion" placeholder="My animal is a">
          </div>

          <h4>Areas of Expertise</h4>
          <div class="expertise-area">
            <strong>1. Environment</strong>
            <p><em>Your familiarity with the wilds—and the creatures that inhabit them—make you a skilled tracker, scout, hunter.</em></p>
          </div>
          <div class="expertise-area">
            <strong>2. Vigilance</strong>
            <p><em>Your watchful eye, survivalist knowledge, and swift reflexes help you keep people alive in harsh conditions. Think archery, trap-setting, crafting, or standing guard.</em></p>
          </div>
          <div class="expertise-area">
            <strong>3. Direction</strong>
            <p><em>Your instinct for navigation guides you through uncertain territory and sharpens your aim.</em></p>
          </div>

          <h4>Special Moves</h4>
          <ul>
            <li>
              <strong>Always Alert:</strong> When you enter combat and act before anyone else.
            </li>
            <li>
              <strong>Tools of the Trade:</strong> When you need to make a specific weapon, tool, or substance.
            </li>
            <li>
              <strong>Trusty Bow:</strong> When you shoot an arrow in a moment of crisis.
            </li>
          </ul>

          <h4>Gear</h4>
          <h5>Equipment</h5>
          <ul class="equipment-list">
            <li>Leather Armor - 1 Armor Points</li>
            <li>Spear (throwable)</li>
            <li>Hunter's Bow with a bundle of 5 arrows (ammo = how many times you can miss)</li>
            <li>Adventure Gear: 5 uses</li>
          </ul>
          <h5>Inventory</h5>
          <div class="text-input">
            <input type="text" name="inventory" placeholder="Write down items you pick up here">
          </div>
          <h5>Journal</h5>
          <div class="text-input">
            <input type="text" name="journal" placeholder="Notes, observations, plans">
          </div>
        </div>

        <!-- The Maverick -->
        <div class="character-sheet">
          <h3>The Maverick</h3>

          <h4>Basic Information</h4>
          <ul>
            <li><strong>Name:</strong> Enter your info</li>
            <li><strong>Level:</strong> 1</li>
            <li><strong>Health:</strong> 3 points max</li>
          </ul>

          <h4>Areas of Expertise</h4>
          <div class="expertise-area">
            <strong>1. Risk</strong>
            <p><em>Odds, chances, and big swings. Your second nature.</em></p>
          </div>
          <div class="expertise-area">
            <strong>2. Chaos</strong>
            <p><em>Disorder. Mayhem. Upheaval. Revolution. It's like your oxygen.</em></p>
          </div>
          <div class="expertise-area">
            <strong>3. Power</strong>
            <p><em>Who has it, who wants it, who's gonna get it next. And, if something takes brute force, you're the one for the job.</em></p>
          </div>

          <h4>Special Moves</h4>
    <ul>
      <li>
        <strong>Vice:</strong> When you give into your vice.<br>
        <strong>Choose your vice:</strong>
        <div class="dropdown">
          <select name="vice">
            <option value="" disabled selected>What's your vice?</option>
            <option value="starting-fights">Starting fights</option>
            <option value="breaking-rules">Breaking rules</option>
            <option value="showing-off">Showing off</option>
            <option value="demanding-attention">Demanding attention</option>
          </select>
        </div>
      </li>
            <li>
              <strong>Bold Gambit:</strong> When you act on an aggressive, unconventional plan with total confidence.
            </li>
            <li>
              <strong>Rage:</strong> When a teammate gets hurt and you strike back immediately.
            </li>
          </ul>

          <h4>Gear</h4>
          <h5>Equipment</h5>
          <ul class="equipment-list">
            <li>Chainmail - 3 Armor Points</li>
            <li>Great Axe</li>
            <li>Adventure Gear: 5 uses</li>
          </ul>
          <h5>Inventory</h5>
          <div class="text-input">
            <input type="text" name="inventory" placeholder="Write down items you pick up here">
          </div>
          <h5>Journal</h5>
          <div class="text-input">
            <input type="text" name="journal" placeholder="Notes, observations, plans">
          </div>
        </div>

        <!-- The Vanguard -->
        <div class="character-sheet">
          <h3>The Vanguard</h3>

          <h4>Basic Information</h4>
          <ul>
            <li><strong>Name:</strong> Enter your info</li>
            <li><strong>Level:</strong> 1</li>
            <li><strong>Health:</strong> 3 points </li>
          </ul>

          <h4>Areas of Expertise</h4>
          <div class="expertise-area">
            <strong>1. Leadership</strong>
            <p><em>Commanding attention, rallying allies, intimidating foes.</em></p>
          </div>
          <div class="expertise-area">
            <strong>2. Tactics</strong>
            <p><em>You know your way around conflict—and any weapon, tool, or technique involved.</em></p>
          </div>
          <div class="expertise-area">
            <strong>3. Strategy</strong>
            <p><em>You can read and predict the flow of conflict.</em></p>
          </div>

          <h4>Special Moves</h4>
          <ul>
            <li>
              <strong>Signature Weapon:</strong> You carry a unique weapon. Using its special quality counts as a special move.
         <div class="dropdown">
                <select name="signature-weapon">
                  <option value="" disabled selected>Select a Weapon</option>
                  <option value="Greatsword">Greatsword — When you overpower</option>
                  <option value="Stiletto">Stiletto — When you pierce</option>
                  <option value="Warhammer">Warhammer — When you smash</option>
                  <option value="Halberd">Halberd — When you reach</option>
                </select>
              </div>
            </li>
            <li>
              <strong>Charge:</strong> When you see a chance to turn the tide of battle.
            </li>
            <li>
              <strong>Protector:</strong> When you stand in direct defense of a teammate.
            </li>
          </ul>

          <h4>Gear</h4>
          <h5>Equipment</h5>
          <ul class="equipment-list">
            <li>Plate Armor – 2 Armor Points</li>
            <li>Shield</li>
            <li><em>Enter Signature Weapon name here</em></li>
            <li>Adventure Gear: 5 uses</li>
          </ul>
          <h5>Inventory</h5>
          <div class="text-input">
            <input type="text" name="inventory" placeholder="Write down items you pick up here">
          </div>
          <h5>Journal</h5>
          <div class="text-input">
            <input type="text" name="journal" placeholder="Notes, observations, plans">
          </div>
        </div>

        <!-- The Magister -->
        <div class="character-sheet">
          <h3>The Magister</h3>

          <h4>Basic Information</h4>
          <ul>
            <li><strong>Name:</strong> Enter your info</li>
            <li><strong>Level:</strong> 1</li>
            <li><strong>Health:</strong> 3 points </li>
            <li><strong>Arcane Shield:</strong> You have a magical shield that passively blocks 1 damage.</li>
          </ul>

          <h4>Areas of Expertise</h4>
          <div class="expertise-area">
            <strong>1. Theory</strong>
            <p><em>Casting spells, understanding magical forces, and applying your academic or arcane knowledge.</em></p>
          </div>
          <div class="expertise-area">
            <strong>2. Analysis</strong>
            <p><em>Breaking puzzles, revealing illusions, solving riddles—when complex situations need solving.</em></p>
          </div>
          <div class="expertise-area">
            <strong>3. Research</strong>
            <p><em>You're a quick study and learned scholar. If it happened, might happen, or could happen, you've probably read about it.</em></p>
          </div>

          <h4>Special Moves</h4>
          <ul>
            <li>
              <strong>Magic Specialty:</strong> Choose your specialty:
              <div class="dropdown">
                <select name="magic-specialty">
                  <option value="" disabled selected>Select a Specialty</option>
                  <option value="create-illusions">Create illusions</option>
                  <option value="enchant-objects">Enchant objects</option>
                  <option value="manipulate-minds">Manipulate minds</option>
                  <option value="reanimate-dead">Reanimate the dead</option>
                </select>
              </div>
            </li>
            <li>
              <strong>Magic Bolt:</strong> When you shoot pure magic (ice, fire, psychic—you decide!) at a target.
            </li>
            <li>
              <strong>Wise Wizard:</strong> When a teammate asks for your help, your advice is always relevant.
            </li>
          </ul>

          <h4>Gear</h4>
          <h5>Equipment</h5>
          <ul class="equipment-list">
            <li>Robes - No Armor Points</li>
            <li>Staff or Wand (Describe it!)</li>
            <li>Bag of Books: 5 uses (Add a die when you share your expertise)</li>
          </ul>
          <h5>Inventory</h5>
          <div class="text-input">
            <input type="text" name="inventory" placeholder="Write down items you pick up here">
          </div>
          <h5>Journal</h5>
          <div class="text-input">
            <input type="text" name="journal" placeholder="Notes, observations, plans">
          </div>
        </div>

        <!-- The Saint -->
        <div class="character-sheet">
          <h3>The Saint</h3>

          <h4>Basic Information</h4>
          <ul>
            <li><strong>Name:</strong> Enter your info</li>
            <li><strong>Level:</strong> 1</li>
            <li><strong>Health:</strong> 3 points </li>
          </ul>

          <h4>Areas of Expertise</h4>
          <div class="expertise-area">
            <strong>1. Faith</strong>
            <p><em>Support, belief, protection, and healing. Your connection to the divine.</em></p>
          </div>
          <div class="expertise-area">
            <strong>2. Spirit</strong>
            <p><em>Birth, death, the afterlife—you're deeply familiar with it all.</em></p>
          </div>
          <div class="expertise-area">
            <strong>3. Empathy</strong>
            <p><em>You are emotionally, mentally, and physically attuned—extraordinarily so.</em></p>
          </div>

          <h4>Special Moves</h4>
    <ul>
      <li>
        <strong>Blessed One:</strong> When you channel your god's power to make magic within their domain or pray for information.
            <div class="dropdown">
          <select name="deity-name">
            <option value="">Choose your god's domain</option>
            <option value="light-truth">Light and Truth</option>
            <option value="shadow-deceit">Shadow and Deceit</option>
            <option value="storm-chaos">Storm and Chaos</option>
            <option value="fate-time">Fate and Time</option>
          </select>
        </div>
      </li>
      <li>
        <strong>Holy Ward:</strong> When you protect or heal someone—or something—using divine magic.
      </li>
    </ul>

          <h4>Gear</h4>
          <h5>Equipment</h5>
          <ul class="equipment-list">
            <li>Robes (Describe them!) – No Armor Points</li>
            <li>Divine Staff (Describe it!)</li>
            <li>Poultices & Herbs: 2 uses (Heals 1 point of health per use)</li>
          </ul>
          <h5>Inventory</h5>
          <div class="text-input">
            <input type="text" name="inventory" placeholder="Write down items you pick up here">
          </div>
          <h5>Journal</h5>
          <div class="text-input">
            <input type="text" name="journal" placeholder="Notes, observations, plans">
          </div>
        </div>

        <!-- The Charmer -->
        <div class="character-sheet">
          <h3>The Charmer</h3>

          <h4>Basic Information</h4>
          <ul>
            <li><strong>Name:</strong> Enter your info</li>
            <li><strong>Level:</strong> 1</li>
            <li><strong>Health:</strong> 3 points </li>
          </ul>

          <h4>Areas of Expertise</h4>
          <div class="expertise-area">
            <strong>1. Influence</strong>
            <p><em>You just… get people. You know what makes them tick.</em></p>
          </div>
          <div class="expertise-area">
            <strong>2. Expression</strong>
            <p><em>The arts, the emotions, the performance—you've mastered them.</em></p>
          </div>
          <div class="expertise-area">
            <strong>3. Culture</strong>
            <p><em>You can show up anywhere and fit right in. You've been there, you've done that—you've probably even heard songs about it.</em></p>
          </div>

          <h4>Special Moves</h4>
    <ul>
      <li>
        <strong>Arcane Art:</strong> When you perform art to create a magical effect—influence, healing, empowerment, and more.
        <div class="dropdown">
          <label for="art-form">Art Form:</label>
          <select name="art-form" id="art-form">
            <option value="music">Music</option>
            <option value="movement">Movement</option>
            <option value="theatrics">Theatrics</option>
            <option value="poetry">Poetry</option>
          </select>
        </div>
      </li>
      <li>
        <strong>Been There:</strong> When you reference a person, place, or trend to gain trust or open doors.
      </li>
    </ul>

          <h4>Gear</h4>
          <h5>Equipment</h5>
          <ul class="equipment-list">
            <li>Leather Armor – 1 Armor Point</li>
            <li>Needlepoint Sword</li>
            <li>Pipeleaf: 5 uses (extra die to persuasion rolls when smoked with someone)</li>
          </ul>
          <h5>Inventory</h5>
          <div class="text-input">
            <input type="text" name="inventory" placeholder="Write down items you pick up here">
          </div>
          <h5>Journal</h5>
          <div class="text-input">
            <input type="text" name="journal" placeholder="Notes, observations, plans">
          </div>
        </div>

        <!-- The Warden -->
        <div class="character-sheet">
          <h3>The Warden</h3>

          <h4>Basic Information</h4>
          <ul>
            <li><strong>Name:</strong> Enter your info</li>
            <li><strong>Level:</strong> 1</li>
            <li><strong>Health:</strong> 3 points</li>
          </ul>

          <h4>Areas of Expertise</h4>
          <div class="expertise-area">
            <strong>1. Justice</strong>
            <p><em>You know every law and code—and when to break them for the greater good.</em></p>
          </div>
          <div class="expertise-area">
            <strong>2. Judgment</strong>
            <p><em>You can always tell what's… off.</em></p>
          </div>
          <div class="expertise-area">
            <strong>3. Control</strong>
            <p><em>You naturally command respect and inspire order. Your movements project focus and discipline in all things—from speech to steel.</em></p>
          </div>

          <h4>Special Moves</h4>
          <ul>
            <li>
              <strong>Virtuous:</strong> When you act in a way that honors your vow:
               <div class="dropdown">
                <select name="virtuous">
                  <option value="" disabled selected>SELECT</option>
                  <option value="Mercy">Mercy</option>
                  <option value="Loyalty">Loyalty</option>
                  <option value="Peace">Peace</option>
                </select>
              </div>
            </li>
            <li>
              <strong>Places, Everyone:</strong> When a teammate follows your direction in combat.
            </li>
          </ul>

          <h4>Gear</h4>
          <h5>Equipment</h5>
          <ul class="equipment-list">
            <li>Weapons & Armor:
              <ul>
                <li>Scale Armor – 2 Armor Points</li>
                <li>Longsword</li>
              </ul>
            </li>
            <li>Bandages: 5 uses (heals 1 point of health per use)</li>
          </ul>
          <h5>Inventory</h5>
          <div class="text-input">
            <input type="text" name="inventory" placeholder="Write down items you pick up here">
          </div>
          <h5>Journal</h5>
          <div class="text-input">
            <input type="text" name="journal" placeholder="Notes, observations, plans">
          </div>
        </div>

      </div>
  </div>
</body>
</html>
